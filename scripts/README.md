# Скрипты деплоя ML-Web

Этот каталог содержит скрипты для развертывания приложения ML-Web.

## Доступные скрипты

### `deploy.py` - Основной скрипт деплоя (Python)

Универсальный скрипт для подготовки приложения к запуску. Выполняет:
- Проверку наличия необходимых директорий
- Применение миграций базы данных (Alembic)
- Проверку подключения к базе данных
- Создание отсутствующих таблиц

**Использование:**
```bash
# С использованием uv (рекомендуется)
uv run python scripts/deploy.py

# Или через Makefile
make deploy
```

**Примечание:** Скрипт автоматически определяет, доступен ли `uv`, и использует его при наличии.

### `deploy.sh` - Скрипт для Linux/macOS

Обертка для запуска `deploy.py` в Unix-подобных системах.

**Использование:**
```bash
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

### `deploy.ps1` - Скрипт для Windows PowerShell

Обертка для запуска `deploy.py` в Windows.

**Использование:**
```powershell
.\scripts\deploy.ps1
```

### `docker-entrypoint.sh` - Entrypoint для Docker контейнера

Скрипт, который выполняется при запуске Docker контейнера. Автоматически применяет миграции перед запуском приложения.

**Использование:**
Скрипт автоматически используется в Dockerfile через ENTRYPOINT. Не требует ручного запуска.

## Что делает скрипт деплоя

1. **Проверка директорий**
   - Создает необходимые директории (`data`, `models`, `reports`), если они отсутствуют

2. **Применение миграций**
   - Проверяет текущую версию миграций
   - Если таблицы уже существуют, помечает базу данных текущей версией миграции
   - Применяет новые миграции, если они есть

3. **Проверка базы данных**
   - Проверяет подключение к базе данных
   - Проверяет наличие необходимых таблиц
   - Создает отсутствующие таблицы при необходимости

## Использование в Docker

При использовании Docker Compose, миграции применяются автоматически при запуске контейнера благодаря `docker-entrypoint.sh`.

```bash
docker compose up --build
```

## Ручной деплой

Если вы разворачиваете приложение без Docker:

1. Установите uv (если еще не установлен):
   ```bash
   # Linux/macOS
   curl -LsSf https://astral.sh/uv/install.sh | sh
   
   # Windows PowerShell
   powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
   ```

2. Установите зависимости:
   ```bash
   uv sync
   ```

3. Запустите скрипт деплоя:
   ```bash
   make deploy
   # или
   uv run python scripts/deploy.py
   ```

4. Запустите приложение:
   ```bash
   uv run uvicorn backend.app.main:app --host 0.0.0.0 --port 8000
   ```

## Устранение проблем

### Ошибка "table already exists"

Если вы видите ошибку о том, что таблицы уже существуют, это означает, что таблицы были созданы вручную. Скрипт автоматически обработает эту ситуацию, пометив базу данных текущей версией миграции.

### Ошибка "Alembic is not installed"

Убедитесь, что все зависимости установлены:
```bash
uv sync
```

### Ошибка подключения к базе данных

Проверьте:
- Существует ли файл базы данных (по умолчанию `data/app.db`)
- Есть ли права на запись в директорию `data/`
- Правильно ли настроен путь к базе данных в `backend/app/config.py`

